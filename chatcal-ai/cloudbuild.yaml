# Cloud Build configuration for cost-efficient deployment
steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'build'
    - '-f'
    - 'Dockerfile.cloudrun'
    - '-t'
    - 'gcr.io/chatcal-ai-prod-monroe919/chatcal-ai:latest'
    - '.'

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'push'
    - 'gcr.io/chatcal-ai-prod-monroe919/chatcal-ai:latest'

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
    - 'run'
    - 'deploy'
    - 'chatcal-ai'
    - '--image'
    - 'gcr.io/chatcal-ai-prod-monroe919/chatcal-ai:latest'
    - '--platform'
    - 'managed'
    - '--region'
    - 'us-east1'
    - '--allow-unauthenticated'
    - '--service-account'
    - 'chatcal-runner@chatcal-ai-prod-monroe919.iam.gserviceaccount.com'
    - '--memory'
    - '512Mi'
    - '--cpu'
    - '1'
    - '--min-instances'
    - '0'
    - '--max-instances'
    - '10'
    - '--concurrency'
    - '100'
    - '--timeout'
    - '300'
    - '--set-env-vars'
    - 'ENVIRONMENT=production,TESTING_MODE=false,GOOGLE_CLIENT_ID=20442616960-t6qd6ru3n9nj88tbd42qpkmhg6jp6851.apps.googleusercontent.com,SMTP_SERVER=smtp.gmail.com,SMTP_PORT=587,SMTP_USERNAME=pgits.job@gmail.com,MY_EMAIL_ADDRESS=pgits.job@gmail.com,MY_PHONE_NUMBER=+16302097542'
    - '--set-secrets'
    - 'GROQ_API_KEY=groq-api-key:latest,SMTP_PASSWORD=smtp-password:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,SECRET_KEY=secret-key:latest,SERVICE_ACCOUNT_KEY=service-account-key:latest'

# Optimize build for cost
options:
  machineType: 'E2_HIGHCPU_8'  # Fast, cost-effective build
  diskSizeGb: 10               # Minimal disk space

# Build timeout
timeout: '600s'